- name: Start Minikube cluster
  shell: minikube start --driver=docker --force
  args:
    creates: /home/{{ ansible_user }}/.minikube

- name: Set up Docker environment for Minikube
  shell: eval $(minikube docker-env)
  args:
    executable: /bin/bash

- name: Pull application Docker image
  shell: docker pull scelle/system-info-app

- name: Deploy application deployment
  copy:
    src: "{{ playbook_dir }}/roles/deploy_app/templates/deployment.yaml"
    dest: /home/{{ ansible_user }}/deployment.yaml

- name: Apply deployment configuration
  shell: kubectl apply -f /home/{{ ansible_user }}/deployment.yaml
  args:
    executable: /bin/bash

- name: Deploy application service
  copy:
    src: "{{ playbook_dir }}/roles/deploy_app/templates/service.yaml"
    dest: /home/{{ ansible_user }}/service.yaml

- name: Apply service configuration
  shell: kubectl apply -f /home/{{ ansible_user }}/service.yaml
  args:
    executable: /bin/bash

- name: Enable Minikube Ingress addon
  shell: minikube addons enable ingress
  args:
    creates: /root/.minikube/addons/ingress_enabled

- name: Wait for Ingress addon to initialize
  pause:
    seconds: 30

- name: Copy Ingress configuration
  copy:
    src: "{{ playbook_dir }}/roles/deploy_app/templates/ingress.yaml"
    dest: /home/{{ ansible_user }}/ingress.yaml

- name: Apply Ingress configuration
  shell: kubectl apply -f /home/{{ ansible_user }}/ingress.yaml
  args:
    executable: /bin/bash
